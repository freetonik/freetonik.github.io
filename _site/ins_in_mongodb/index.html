<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Важнейшие $in'ы: производительность MongoDB в диапазонах &#8211; Блог Рахима Давлеткалиева</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Приветствую, искатели приключений! Путешествуя по территории индексации MongoDB хотя бы некоторое время, вы, возможно, познакомились с таким правилом: если ваш запрос содержит сортировку/порядок (orderby) – добавьте сортируемое поле в конец индекса который используется для запроса.">
    <meta name="author" content="Рахим Давлеткалиев">
    <meta name="keywords" content="translations">
    <link rel="canonical" href="https://rakh.im/ins_in_mongodb/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Блог Рахима Давлеткалиева" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?201601121020" type="text/css">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- Verifications -->
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="ru_RU">
    <meta property="fb:app_id" content="125006834268789" /> 
    <meta property="og:type" content="article">
    <meta property="og:title" content="Важнейшие $in&#39;ы: производительность MongoDB в диапазонах">
    <meta property="og:description" content="Блог Рахима Давлеткалиева">
    <meta property="og:url" content="https://rakh.im/ins_in_mongodb/">
    <meta property="og:site_name" content="Блог Рахима Давлеткалиева">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@freetonik" />
    
    <meta name="twitter:title" content="Важнейшие $in'ы: производительность MongoDB в диапазонах" />
    <meta name="twitter:description" content="Приветствую, искатели приключений! Путешествуя по территории индексации MongoDB хотя бы некоторое время, вы, возможно, познакомились с таким правилом: если ваш запрос содержит сортировку/порядок (orderby) – добавьте сортируемое поле в конец индекса который используется для запроса." />
    <meta name="twitter:url" content="https://rakh.im/ins_in_mongodb/" />

    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="&nbsp;"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="mstile-310x310.png" />

    
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1360700-19']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    
</head>

<body class="site">

  <div class="topline">
    <div class="topline-block" id="topline-block-1"></div>
    <div class="topline-block" id="topline-block-2"></div>
    <div class="topline-block" id="topline-block-3"></div>
    <div class="topline-block" id="topline-block-4"></div>
    <div class="topline-block" id="topline-block-5"></div>
  </div>

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="/" class="site-title">Rakh.im</a>
      <nav class="site-nav">
        
  
    <a class="fa fa-twitter" href="https://twitter.com/freetonik"></a>
  
  
    <a class="fa fa-facebook" href="https://facebook.com/freetonik"></a>
  
  
  
  
    <a class="fa fa-instagram" href="https://instagram.com/freetonik"></a>
  
  <a class="fa fa-rss" href="/feed.xml"></a>


      </nav>
      <div class="clearfix"></div>
    </div>
  </div>
</header>


    


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Важнейшие $in'ы: производительность MongoDB в диапазонах</h1>
  <span class="post-meta">7.03.2013, 
  Перевод

</span><br>
  
  <span class="post-meta small">
  
    3 мин.
  
  </span>
</div>

<article class="post-content">
  <p>Приветствую, искатели приключений! Путешествуя по территории индексации MongoDB хотя бы некоторое время, вы, возможно, познакомились с таким правилом: если ваш запрос содержит сортировку/порядок (orderby) – добавьте сортируемое поле в конец индекса который используется для запроса.</p>

<p>Во многих случаях когда запрос содержит равенство (то есть поиск конкретного значения, например, {“name” : “Charlie”}) данная мантра бывает весьма полезной.</p>

<h4 id="section">Запрос</h4>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">db</span><span class="p">.</span><span class="nx">drivers</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s2">&quot;country&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">]}})</span>
          <span class="p">.</span><span class="nx">sort</span><span class="p">({</span><span class="s2">&quot;carsOwned&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">})</span></code></pre></div>

<h4 id="section-1">Индекс</h4>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span><span class="s2">&quot;country&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;carsOwned&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">}</span></code></pre></div>

<p>Такая комбинация будет не такой эффективной, как может показаться, не смотря на то, что индекс соответствует правилу. В этом запросе есть ловушка, в которую вы с легкостью попадете следуя общепринятому мнению.</p>

<p>Давайте разберемся что здесь не так и что делать в таких случаях. Но для начала, не смотря на то что этот пост не про основы индексации, освежим память по этой теме с помощью <a href="http://docs.mongodb.org/manual/core/indexes/">документации</a> MongoDB:</p>

<h4 id="section-2">Индексируйте заранее</h4>
<p>Индексы заслуживают особого внимания в процессе дизайна. Исторически сложилось так что вопрос ответственность за эффективность доступа к данным ложится на администратора базы данных. Это провоцирует создание слоев оптимизации уже после дизайна, что документо-ориентируемая база может избежать.</p>

<h4 id="section-3">Индексируйте часто</h4>
<p>Индексированные запросы на порядок эффективнее обычных даже с небольшим количеством данных. Если неиндексированный запрос длится 10 секунд, тот же самый запрос может быть выполнен за 0 миллисекунд при использовании правильного индекса.</p>

<h4 id="section-4">Индексируйте полностью</h4>
<p>Запросы используют индексы слева направо. Индекс может быть использован только до тех пор пока запрос использует все поля и не пропускает ни одного.</p>

<h4 id="section-5">Индексируйте сортировку</h4>
<p>Если ваш запрос содержит сортировку или оператор orderby – добавьте сортируемое поле в индекс.</p>

<h4 id="section-6">Команды</h4>
<p><code>.explain()</code> показывает использовался ли индекс (наряду с другой полезной информацией – прим. пер.),
<code>.ensureIndex() </code>создает индекс,
<code>.getIndexes()</code> или <code>.getIndexKeys()</code> выводит список индексов для коллекции.</p>

<p>Вернемся к нашей проблеме. Держа в голове эти базовые знания, расхожее мнение гласит что для следующего запроса:</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="err">“</span><span class="nx">country</span><span class="err">”</span><span class="o">:</span> <span class="err">“</span><span class="nx">A</span><span class="err">”</span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="err">“</span><span class="nx">carsOwned</span><span class="err">”</span><span class="o">:</span> <span class="mi">1</span><span class="p">})</span></code></pre></div>

<p>Необходимо создать следующий индекс:</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">ensureIndex</span><span class="p">({</span><span class="s2">&quot;country&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;carsOwned&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">})</span></code></pre></div>

<p>Что если в большинстве запросов применяется диапазон вместо равенства? Как тут:</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s2">&quot;country&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">]}})</span>
             <span class="p">.</span><span class="nx">sort</span><span class="p">({</span><span class="s2">&quot;carsOwned&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">})</span></code></pre></div>

<p>Здесь мы используем <code>$in</code>, но то же самое работает для <code>$gt</code>, <code>$lt</code> и т.д.</p>

<p>Если вы заметили что такие запросы выполняются медленно, и вы помните основы о которых мы говорили, то запустите <code>.explain()</code> и посмотрите какой индекс использовался. Но вы также увидите <code>{scanAndOrder : true}</code>, который означает что MongoDB произвела сортировку. Причина медленного выполнения запроса именно в этом: scanAndOrder – дорогая операция, потому что она сортирует документы в памяти. Ее нужно избегать при работе с большими массивами данных, она медленная и сильно нагружает процессор.</p>

<p>Но забудьте о причинах медленной работы scanAndOrder; почему MongoDB сортирует результаты если мы уже добавили это поле в индекс? Ответ прост: мы не сделали этого.</p>

<p>Почему? Ответ кроется в структуре индекса который мы создали. В нашем примере документ с <code>{“country”: “A”}</code> и документ с <code>{“country”: “G”}</code> отсортированы в индексе по ключу <code>{“carsOwned”: 1}</code>, но они отсортированы независимо друг от друга. Они не отсортированы вместе!</p>

<p><img src="/images/posts/mongo.png" alt="mongo ins" /></p>

<p>Схема слева иллюстрирует порядок посещения документов в соответствии с индексом который мы создали. Когда все документы, соответствующие запросу, найдены, их следует отсортировать. Схема справа показывает работу запроса с альтернативным индексом: <code>{ “carsOwned”: 1, “country”: 1}</code>. Переместив поле сортировки ближе к началу (влево) индекса мы создали сценарий в котором MongoDB посещает документы в том порядке, который нам требуется. Из этой эффективной хитрости следует простой набор правил для индексации:</p>

<h5 id="section-7">Порядок полей в индексе должен быть таким:</h5>
<ol>
  <li>Сначала – поля, которые используются в запросе на точные значения.</li>
  <li>Затем – сортируемые поля.</li>
  <li>И в конце – поля, которые используются для поиска в диапазонах.</li>
</ol>

<p>Идем ли мы на компромисс? Да. Запрос посетит большее количество документов чем технически необходимо, потому что посещения сортируемой части индекса произойдут перед применением оператора диапазонов. Помните эти простые правила, но имейте ввиду, что размеры ваших данных может приводить и к иным результатам.</p>

<p>Надеюсь это руководство окажется для вас полезным. Удачи, искатели приключений!</p>

<p>Искренне ваш,
Эрик из MongoLab.</p>

  
    <p class="right-align">
      <small>
        <a target="_blank" href="http://habrahabr.ru/post/171919/">Впервые опубликовано на Habrahabr</a>

        
          
            /
          
        

        
          <a target="_blank" href="http://blog.mongolab.com/2012/06/cardinal-ins/">Оригинал от Eric Sedor</a>
        
      </small>
    </p>
  
</article>




  <div class="py2 post-footer">
  <hr />
  <img src="/images/me.jpeg" alt="Rakhim Davletkaliyev" class="avatar" />
  <p>
    Меня зовут Рахим. Я работаю над образовательным проектом <a href="https://hexlet.io?utm_medium=blog&utm_source=rakhim&utm_campaign=rakhim_homepage">Хекслет</a>. В этом блоге я пишу о жизни, компьютерах, людях и их языках. Особенно об английском. <a href="/subscribe">Подписывайтесь</a>.
  </p>
  <p>
    А еще у меня есть <a href="https://twitter.com/freetonik">Твиттер</a>.
  </p>
</div>







      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      Тема оформления от <a href="http://johnotander.com">Джона Отандера</a>.<br>
      Сделано на планете Земля.<br>
      (Измерение C137)<br>
    </small>
    <div class="mt1">
      &#127757;
    </div>
  </div>
</footer>

</body>
</html>
